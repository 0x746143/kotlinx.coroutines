<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>kotlinx-coroutines-debug</title>
  <meta name="description" content="Library support for kotlin coroutines">
  <link rel="stylesheet" href="/kotlinx.coroutines/assets/main.css">
  <link rel="canonical" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="/kotlinx.coroutines/assets/js/api.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-47631155-3', 'auto');
    ga('send', 'pageview');
  </script>
</head>

  <body>
    <header class="site-header" role="banner">
  <div class="wrapper">
    <a class="site-title" href="/kotlinx.coroutines/">kotlinx.coroutines</a>
  </div>
</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <p>Debugging facilities for <code>kotlinx.coroutines</code> on JVM.</p>

<h3 id="overview">Overview</h3>

<p>This module provides a debug JVM agent that allows to track and trace existing coroutines.
The main entry point to debug facilities is <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/index.html">DebugProbes</a> API.
Call to <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/install.html">DebugProbes.install</a> installs debug agent via ByteBuddy and starts spying on coroutines when they are created, suspended and resumed.</p>

<p>After that, you can use <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/dump-coroutines.html">DebugProbes.dumpCoroutines</a> to print all active (suspended or running) coroutines, including their state, creation and
suspension stacktraces.
Additionally, it is possible to process the list of such coroutines via <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/dump-coroutines-info.html">DebugProbes.dumpCoroutinesInfo</a> or dump isolated parts
of coroutines hierarchy referenced by a <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/index.html">Job</a> or <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html">CoroutineScope</a> instances using  <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/print-job.html">DebugProbes.printJob</a> and <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/print-scope.html">DebugProbes.printScope</a> respectively.</p>

<h3 id="using-in-your-project">Using in your project</h3>

<p>Add <code>kotlinx-coroutines-debug</code> to your project test dependencies:</p>

<pre>dependencies {
    testImplementation 'org.jetbrains.kotlinx:kotlinx-coroutines-debug:1.2.0-alpha'
}
</pre>

<h3 id="using-in-unit-tests">Using in unit tests</h3>

<p>For JUnit4 debug module provides special test rule, <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug.junit4/-coroutines-timeout/index.html">CoroutinesTimeout</a>, for installing debug probes
and to dump coroutines on timeout to simplify tests debugging.</p>

<p>Its usage is better demonstrated by the example (runnable code is <a href="test/TestRuleExample.kt">here</a>):</p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TestRuleExample</span> <span class="p">{</span>
    <span class="n">@Rule</span>
    <span class="n">@JvmField</span>
    <span class="k">public</span> <span class="kd">val</span> <span class="py">timeout</span> <span class="p">=</span> <span class="n">CoroutinesTimeout</span><span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>

    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">someFunctionDeepInTheStack</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">delay</span><span class="p">(</span><span class="n">Long</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">)</span> <span class="c1">// Hang method
</span>        <span class="p">}</span>  
    <span class="p">}</span>

    <span class="n">@Test</span>
    <span class="k">fun</span> <span class="nf">hangingTest</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">job</span> <span class="p">=</span> <span class="n">launch</span> <span class="p">{</span>
            <span class="n">someFunctionDeepInTheStack</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">job</span><span class="p">.</span><span class="n">join</span><span class="p">()</span> <span class="c1">// Join will hang
</span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>After 1 second, test will fail with <code>TestTimeoutException</code> and all coroutines (<code>runBlocking</code> and <code>launch</code>) and their
stacktraces will be dumped to the console.</p>

<h3 id="using-as-jvm-agent">Using as JVM agent</h3>

<p>It is possible to use this module as a standalone JVM agent to enable debug probes on the application startup.
You can run your application with an additional argument: <code>-javaagent:kotlinx-coroutines-debug-1.2.0-alpha.jar</code>.
Additionally, on Linux and Mac OS X you can use <code>kill -5 $pid</code> command in order to force your application to print all alive coroutines.</p>

<h3 id="example-of-usage">Example of usage</h3>

<p>Capabilities of this module can be demonstrated by the following example 
(runnable code is <a href="test/Example.kt">here</a>):</p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">computeValue</span><span class="p">():</span> <span class="n">String</span> <span class="p">=</span> <span class="n">coroutineScope</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">one</span> <span class="p">=</span> <span class="n">async</span> <span class="p">{</span> <span class="n">computeOne</span><span class="p">()</span> <span class="p">}</span>
    <span class="kd">val</span> <span class="py">two</span> <span class="p">=</span> <span class="n">async</span> <span class="p">{</span> <span class="n">computeTwo</span><span class="p">()</span> <span class="p">}</span>
    <span class="n">combineResults</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">suspend</span> <span class="k">fun</span> <span class="nf">combineResults</span><span class="p">(</span><span class="n">one</span><span class="p">:</span> <span class="n">Deferred</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;,</span> <span class="n">two</span><span class="p">:</span> <span class="n">Deferred</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;):</span> <span class="n">String</span> <span class="p">=</span>
    <span class="n">one</span><span class="p">.</span><span class="n">await</span><span class="p">()</span> <span class="p">+</span> <span class="n">two</span><span class="p">.</span><span class="n">await</span><span class="p">()</span>

<span class="n">suspend</span> <span class="k">fun</span> <span class="nf">computeOne</span><span class="p">():</span> <span class="n">String</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="m">5000</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"4"</span>
<span class="p">}</span>

<span class="n">suspend</span> <span class="k">fun</span> <span class="nf">computeTwo</span><span class="p">():</span> <span class="n">String</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="m">5000</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"2"</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
    <span class="n">DebugProbes</span><span class="p">.</span><span class="n">install</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">deferred</span> <span class="p">=</span> <span class="n">async</span> <span class="p">{</span> <span class="n">computeValue</span><span class="p">()</span> <span class="p">}</span>
    <span class="c1">// Delay for some time
</span>    <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
    <span class="c1">// Dump running coroutines
</span>    <span class="n">DebugProbes</span><span class="p">.</span><span class="n">dumpCoroutines</span><span class="p">()</span>
    <span class="n">println</span><span class="p">(</span><span class="s">"\nDumping only deferred"</span><span class="p">)</span>
    <span class="n">DebugProbes</span><span class="p">.</span><span class="n">printJob</span><span class="p">(</span><span class="n">deferred</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Printed result will be:</p>

<pre>Coroutines dump 2018/11/12 21:44:02

Coroutine "coroutine#2":DeferredCoroutine{Active}@289d1c02, state: SUSPENDED
	at kotlinx.coroutines.DeferredCoroutine.await$suspendImpl(Builders.common.kt:99)
	at ExampleKt.combineResults(Example.kt:11)
	at ExampleKt$computeValue$2.invokeSuspend(Example.kt:7)
	at ExampleKt$main$1$deferred$1.invokeSuspend(Example.kt:25)
	(Coroutine creation stacktrace)
	at kotlin.coroutines.intrinsics.IntrinsicsKt__IntrinsicsJvmKt.createCoroutineUnintercepted(IntrinsicsJvm.kt:116)
	at kotlinx.coroutines.intrinsics.CancellableKt.startCoroutineCancellable(Cancellable.kt:25)
	at kotlinx.coroutines.BuildersKt.async$default(Unknown Source)
	at ExampleKt$main$1.invokeSuspend(Example.kt:25)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:32)
	at kotlinx.coroutines.DispatchedTask.run(Dispatched.kt:233)
	at kotlinx.coroutines.BuildersKt.runBlocking$default(Unknown Source)
	at ExampleKt.main(Example.kt:23)
	at ExampleKt.main(Example.kt)

... More coroutines here ...

Dumping only deferred
"coroutine#2":DeferredCoroutine{Active}, continuation is SUSPENDED at line kotlinx.coroutines.DeferredCoroutine.await$suspendImpl(Builders.common.kt:99)
			"coroutine#3":DeferredCoroutine{Active}, continuation is SUSPENDED at line ExampleKt.computeOne(Example.kt:14)
		"coroutine#4":DeferredCoroutine{Active}, continuation is SUSPENDED at line ExampleKt.computeTwo(Example.kt:19)
</pre>

<h3 id="status-of-the-api">Status of the API</h3>

<p>API is purely experimental and it is not guaranteed that it won’t be changed (while it is marked as <code>@ExperimentalCoroutinesApi</code>).
Do not use this module in production environment and do not rely on the format of the data produced by <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-debug/kotlinx.coroutines.debug/-debug-probes/index.html">DebugProbes</a>.</p>

<h3 id="debug-agent-and-android">Debug agent and Android</h3>

<p>Unfortunately, Android runtime does not support Instrument API necessary for <code>kotlinx-coroutines-debug</code> to function, triggering <code>java.lang.NoClassDefFoundError: Failed resolution of: Ljava/lang/management/ManagementFactory;</code>.</p>

<p>Nevertheless, it will be possible to support debug agent on Android as soon as <a href="https://github.com/Archinamon/android-gradle-aspectj">GradleAspectJ-Android</a>  will support androin-gradle 3.3</p>

<h3 id="packages">Packages</h3>

<table class="api-docs-table">
<tbody>
<tr>
<td>

        <p><a href="kotlinx.coroutines.debug/index.html">kotlinx.coroutines.debug</a></p>

      </td>
<td>

      </td>
</tr>
<tr>
<td>

        <p><a href="kotlinx.coroutines.debug.junit4/index.html">kotlinx.coroutines.debug.junit4</a></p>

      </td>
<td>

      </td>
</tr>
</tbody>
</table>

<h3 id="index">Index</h3>

<p><a href="alltypes/index.html">All Types</a></p>

      </div>
    </main>
    <footer class="site-footer">
  <!-- empty -->
</footer>

  </body>
</html>

